---
id: A1.计算机网络
title: A1.计算机网络
typora-root-url: ../
---

[TOC]

# 计算机网络概论

![img](/Image/A1.计算机网络-photo/680403129a371fb7_img3-1623741071017)

### 入网物理层面

![img](/Image/A1.计算机网络-photo/680403129a371fb7_img4-1623741071018)

DSL：用户数据线

网络上行下行不对称：0\~4k\~50k\~1M

DSLAM：复用器

![img](/Image/A1.计算机网络-photo/680403129a371fb7_img5-1623741071018)

HFC：光纤同轴

长距离：光纤；短距离：同轴电缆

![img](/Image/A1.计算机网络-photo/680403129a371fb7_img6-1623741071018)

FTTH：光纤入户

光纤分配器：分光器，光猫modem

![img](/Image/A1.计算机网络-photo/680403129a371fb7_img7-1623741071018)

搭建局域网

### TCP/IP四层模型

![image-20210614182857701](/Image/A1.计算机网络-photo/image-20210614182857701-1623741071018.png)



![image-20210614182903641](/Image/A1.计算机网络-photo/image-20210614182903641-1623741071018.png)

![image-20210614182908940](/Image/A1.计算机网络-photo/image-20210614182908940-1623741071018.png)



#### 各层作用及协议

| 分层       | 作用                                                       | 协议                                               | 对应设备                                         | 协议数据单元                           |
| ---------- | ---------------------------------------------------------- | -------------------------------------------------- | ------------------------------------------------ | -------------------------------------- |
| 应用层     | 为应用程序提供服务                                         | FTP、DNS、HTTP、WWW、NFS                           | 计算机                                           | 应用协议数据单元 APDU                  |
| 表示层     | 数据格式转换，数据加密                                     | JPEG、Telnet、SNMP(SNMP（简单网络管理协议)         | 计算机                                           | 表示协议数据单元 PPDU                  |
| 会话层     | 建立、管理和维护会话                                       | SSH、SMTP                                          | 计算机                                           | 会话协议数据单元 SPDU<br />报文message |
| 运输层     | 提供端到端的可靠报文传递和错误恢复                         | TCP、UDP、SPX                                      | 进程和端口                                       | 报文段Segment<br />用户数据报          |
| 网络层     | 负责数据包从源到宿的传递和网际互连；<br />IP选址和路由选择 | IP、ICMP、ARP、RARP、OSPF、IPX、RIP、IGRP          | 路由器、防火墙、<br />多层交换机(提供路由)       | IP数据报（分组）<br />包 Packet        |
| 数据链路层 | 将比特组装成帧和点到点的传递<br />提供介质访问和链路管理   | PPP(点到点)、FR、HDLC、VLAN、MAC、Ethernet(以太网) | 网卡，网桥(不同网络互联)，<br />交换机(同一网络) | 帧 Frame                               |
| 物理层     | 通过媒介传输比特                                           | IEEE802.3                                          | 中继器，集线器HUB，网线                          | 比特bit                                |

# 常用端口

|       应用       | 应用层协议 | 端口号  | 传输层协议 |            备注             |
| :--------------: | :--------: | :-----: | :--------: | :-------------------------: |
|     域名解析     |    DNS     |   53    |  UDP/TCP   | 长度超过 512 字节时使用 TCP |
| 动态主机配置协议 |    DHCP    |  67/68  |    UDP     |                             |
| 简单网络管理协议 |    SNMP    | 161/162 |    UDP     |                             |
|   文件传送协议   |    FTP     |  20/21  |    TCP     |  控制连接 21，数据连接 20   |
|   远程终端协议   |   TELNET   |   23    |    TCP     |                             |
|  超文本传送协议  |    HTTP    |   80    |    TCP     |                             |
| 简单邮件传送协议 |    SMTP    |   25    |    TCP     |                             |
|   邮件读取协议   |    POP3    |   110   |    TCP     |                             |
| 网际报文存取协议 |    IMAP    |   143   |    TCP     |                             |

分层目的：独立分工，业务逻辑抽象

#### 各层功能

- 差错控制
- 流量控制
- 分段和服用
- 复用和分用
- 连接建立和释放



![image-20210614182917819](/Image/A1.计算机网络-photo/image-20210614182917819-1623741071018.png)



#### 网络协议组成要素

- 语法
- 语义
- 同步:确定时间的发生顺序



#### 分组交换

Message->Packet

![img](/Image/A1.计算机网络-photo/680403129a371fb7_img19-1623741071018)

等包的全部数据收齐再转发,否则:残包舍弃

![img](/Image/A1.计算机网络-photo/680403129a371fb7_img20-1623741071018-1623744033311)

ROUTER(路由器):存在输入输出缓冲区,当输出队列数据满后,主动丢包(超时重传)

网络延迟:单个包

![image-20210614182932880](/Image/A1.计算机网络-photo/image-20210614182932880-1623741071018.png)

#### 路由转发表(实时更新)

1. 网络 ID（Network ID, Network number）：就是目标地址的网络 ID。
2. 子网掩码（subnet mask）：用来判断 IP 所属网络
3. 下一跳地址/接口（Next hop / interface）：就是数据在发送到目标地址的旅途中下一站的地址。其中 interface 指向 next hop（即为下一个 route）。一个自治系统（AS, Autonomous system）中的 route 应该包含区域内所有的子网络，而默认网关（Network id: `0.0.0.0`, Netmask: `0.0.0.0`）指向自治系统的出口。

根据应用和执行的不同，路由表可能含有如下附加信息：

1. 花费（Cost）：就是数据发送过程中通过路径所需要的花费。
2. 路由的服务质量
3. 路由中需要过滤的出/入连接列表

![image-20210614182957060](/Image/A1.计算机网络-photo/image-20210614182957060-1623741071018.png)

电路交换:占用信道,独享,安全领域

![img](/Image/A1.计算机网络-photo/680403129a371fb7_img24-1623741071018)

频分复用:4051

![img](/Image/A1.计算机网络-photo/680403129a371fb7_img25-1623741071018)

![img](/Image/A1.计算机网络-photo/680403129a371fb7_img28-1623741071018)

![img](/Image/A1.计算机网络-photo/680403129a371fb7_img30-1623741071018)



# 应用层协议

#### 应用层协议网络应用程序的体系结构

- C/S结构
- P2P结构

![img](/Image/A1.计算机网络-photo/724d99d60c222ef8_img4-1623741071018)

![img](/Image/A1.计算机网络-photo/724d99d60c222ef8_img5-1623741071018)

#### 进程通信

- 所有CS结构的网络应用程序,都是由成对的进程组成
- 在P2P结构中,发起通信为客户端,等待服务的进程为服务器

P2P:两主机为对等方,(百度网盘由中心节点,占用网络,计算机资源),不安全,没有激励机制

#### socket套接字:

- 应用程序与网络的APT
- 对运输层仅限于选择传输协议和设定参数

#### 进程寻址

​	进程(开发者控制)->套接字(操作系统控制)->TCP<->因特网

#### 可供应用程序使用的运输服务

- 可靠数据传输
- 图奴良
- 定时
- 安全性

![img](/Image/A1.计算机网络-photo/724d99d60c222ef8_img11-1623741071018)

TCP:面向连接的服务,可靠的数据传输

UDP:不提供必要服务的轻量级运输服务,不可靠的数据传输

![img](/Image/A1.计算机网络-photo/724d99d60c222ef8_img14-1623741071018)

#### 应用层协议定义

- 交换报文类型,如请求报文和响应报文
- 各种报文类型的语法,如报文中各个字段的定义以及这些字段的描述
- 字段的语义,即这些字段中包含的信息的含义
- 一个进程何时以及如何发送报文,对报文进行响应的规则

## WEB与HTTP协议

#### WEB服务的应用层协议

- HTTP（HyperText Transfer Protocol，超文本传输协议）是一种用于分布式、协作式和超媒体信息系统的应用层协议。HTTP 是万维网的数据通信的基础。\
- 客户程序和服务器程序运行在不同的端系统中(==C/S结构==),通过交换报文进行会话

#### WEB术语

- Web页面(Web page, 文档)

- 对象(对象树)

- HTML基本文件

- URL

  * URL（Uniform Resource Locator，统一资源定位符）是因特网上标准的资源的地址

  - 标准格式：`协议类型:[//服务器地址[:端口号]][/资源层级UNIX文件路径]文件名[?查询][#片段ID]`

  > 其中【访问凭证信息@；:端口号；?查询；#片段ID】都属于选填项  
  > 如：`https://github.com/huihut/interview#cc`

- Web浏览器

- Web服务器

![img](/Image/A1.计算机网络-photo/724d99d60c222ef8_img19-1623741071018)

#### HTTP特点

- HTTP不用担心数据丢失,TCP协议

- HTTP是一个无状态协议,服务器不存储关于客户的状态信息

- HTTP服务器总是处于打开状态,具有一个固定IP

- HTTP使用C/S结构

#### 非持续连接(短连接)和持续连接(长连接)

1. HTTP客户端发起一个到服务器的TCP连接,使用默认端口80,服务器上和客户端上都有一个套接字与之对应

2. HTTP客户经socket向服务器发送请求GET报文,报文包好请求对象

3. HTTP服务器接受该报文,从服务器上检索对象,在HTTP响应报文中封装该对象,并通过socket发送

4. HTTP服务器通知TCP断开TCP连接

5. HTTP客户接收响应报文,TCP连接关闭

6. 对于多个对象重复上述

#### 请求报文

![image-20210614183021599](/Image/A1.计算机网络-photo/image-20210614183021599-1623741071018.png)

#### 请求方法

| 方法    | 意义                                                         |
| ------- | ------------------------------------------------------------ |
| OPTIONS | 请求一些选项信息，允许客户端查看服务器的性能                 |
| GET     | 请求指定的页面信息，并返回实体主体                           |
| HEAD    | 类似于 get 请求，只不过返回的响应中没有具体的内容，用于获取报头 |
| POST    | 向指定资源提交数据进行处理请求（例如提交表单或者上传文件）。数据被包含在请求体中。POST请求可能会导致新的资源的建立和/或已有资源的修改 |
| PUT     | 从客户端向服务器传送的数据取代指定的文档的内容               |
| DELETE  | 请求服务器删除指定的页面                                     |
| TRACE   | 回显服务器收到的请求，主要用于测试或诊断                     |

#### 状态码（Status-Code）

* 1xx：表示通知信息，如请求收到了或正在进行处理
  * 100 Continue：继续，客户端应继续其请求
* 2xx：表示成功，如接收或知道了
  * 200 OK: 请求成功
* 3xx：表示重定向，如要完成请求还必须采取进一步的行动
  * 301 Moved Permanently: 永久移动。请求的资源已被永久的移动到新 URL，返回信息会包括新的 URL，浏览器会自动定向到新 URL。今后任何新的请求都应使用新的 URL 代替
* 4xx：表示客户的差错，如请求中有错误的语法或不能完成
  * 400 Bad Request: 客户端请求的语法错误，服务器无法理解
  * 403 Forbidden: 服务器理解请求客户端的请求，但是拒绝执行此请求（权限不够）
  * 404 Not Found: 服务器无法根据客户端的请求找到资源（网页）。通过此代码，网站设计人员可设置 “您所请求的资源无法找到” 的个性页面
  * 408 Request Timeout: 服务器等待客户端发送的请求时间过长，超时
* 5xx：表示服务器的差错，如服务器失效无法完成请求
  * 500 Internal Server Error: 服务器内部错误，无法完成请求
  * 505 HTTP Version Not Supportted

#### 用户与服务器的交互--COOKIE

- 在HTTP响应报文中的一个cookie首部行
- 在HTTP请求报文中的一个cookie首部行
- 在用户端有浏览器管理的cookie文件
- 位于WEB后端的一个数据库



![image-20210614183029678](/Image/A1.计算机网络-photo/image-20210614183029678.png)



#### WEB缓存器

![img](/Image/A1.计算机网络-photo/724d99d60c222ef8_img29-1623741071018)

WEB缓存器优点

- 大大减少客户请求的响应时间(如何缓存器中存在直接返回)



### HTTP协议与HTTPS协议

HTTP->TCP

HTTPS->SSL(加密)/TLS(解密)->TCP

#### HTTPS

- https协议需要申请证书
- http是超文本传输协议,信息是明文传输,https是具有安全性的ssl加密传输协议
- http(80)和https(443端口)是完全不同的连接方式
- http连接简单,无状态
- https协议是SSL+HTTP,可进行加密传输和身份认证的网络协议

#### HTTP2

![img](/Image/A1.计算机网络-photo/724d99d60c222ef8_img35-1623741071018)

### FTP协议

![img](/Image/A1.计算机网络-photo/724d99d60c222ef8_img37-1623741071018)

![image-20210614183038392](/Image/A1.计算机网络-photo/image-20210614183038392-1623741071018.png)

21控制端口是长连接:不进行任何操作,仍不会断开

20数据端口是短连接:可以通过关闭连接表示一个文件传输完毕

FTP使用客户/服务器模式，使用 TCP 数据报，提供交互式访问，双向传输。



#### FTP命令和回答

| 命令          | 解释                                   |
| ------------- | -------------------------------------- |
| USER          | username                               |
| PASS          | passwd                                 |
| LIST          | 请求文件列表,数据连接,新建且非连续连接 |
| RETR filename | get文件                                |
| STRO filename | put文件                                |

典型回答:331 Username OK, Password Required

### SMTP,POP3,IMAP协议

![img](/Image/A1.计算机网络-photo/724d99d60c222ef8_img42-1623741071018)

一个电子邮件系统由三部分组成：用户代理、邮件服务器以及邮件协议。

邮件协议包含发送协议和读取协议，发送协议常用 SMTP(简单邮件传输协议)，读取协议常用 POP3 和 IMAP

### DNS协议

主机名->IP地,

* DNS（Domain Name System，域名系统）是互联网的一项服务。它作为将域名和 IP 地址相互映射的一个分布式数据库，能够使人更方便地访问互联网。DNS 使用 TCP 和 UDP 端口 53。当前，对于每一级域名长度的限制是 63 个字符，域名总长度则不能超过 253 个字符。

域名：

* `域名 ::= {<三级域名>.<二级域名>.<顶级域名>}`，如：`blog.huihut.com`

集中式DNS可能的问题

- 单点故障
- 通信容量大
- 远离集中式数据库的,时延高
- 维护不易

![img](/Image/A1.计算机网络-photo/724d99d60c222ef8_img47-1623741071018)

1,8递归,2,3,4,5,6,7迭代

TLD顶级域服务器.com;.cn

![img](/Image/A1.计算机网络-photo/724d99d60c222ef8_img48-1623741071018)





## Web 页面请求过程

### 1. DHCP 配置主机信息

- 假设主机最开始没有 IP 地址以及其它信息，那么就需要先使用 DHCP 来获取。

- 主机生成一个 DHCP 请求报文，并将这个报文放入具有目的端口 67 和源端口 68 的 UDP 报文段中。

- 该报文段则被放入在一个具有广播 IP 目的地址(255.255.255.255) 和源 IP 地址（0.0.0.0）的 IP 数据报中。

- 该数据报则被放置在 MAC 帧中，该帧具有目的地址 FF:FF:FF:FF:FF:FFF，将广播到与交换机连接的所有设备。

- 连接在交换机的 DHCP 服务器收到广播帧之后，不断地向上分解得到 IP 数据报、UDP 报文段、DHCP 请求报文，之后生成 DHCP ACK 报文，该报文包含以下信息：IP 地址、DNS 服务器的 IP 地址、默认网关路由器的 IP 地址和子网掩码。该报文被放入 UDP 报文段中，UDP 报文段有被放入 IP 数据报中，最后放入 MAC 帧中。

- 该帧的目的地址是请求主机的 MAC 地址，因为交换机具有自学习能力，之前主机发送了广播帧之后就记录了 MAC 地址到其转发接口的交换表项，因此现在交换机就可以直接知道应该向哪个接口发送该帧。

- 主机收到该帧后，不断分解得到 DHCP 报文。之后就配置它的 IP 地址、子网掩码和 DNS 服务器的 IP 地址，并在其 IP 转发表中安装默认网关。

### 2. ARP 解析 MAC 地址

- 主机通过浏览器生成一个 TCP 套接字，套接字向 HTTP 服务器发送 HTTP 请求。为了生成该套接字，主机需要知道网站的域名对应的 IP 地址。

- 主机生成一个 DNS 查询报文，该报文具有 53 号端口，因为 DNS 服务器的端口号是 53。

- 该 DNS 查询报文被放入目的地址为 DNS 服务器 IP 地址的 IP 数据报中。

- 该 IP 数据报被放入一个以太网帧中，该帧将发送到网关路由器。

- DHCP 过程只知道网关路由器的 IP 地址，为了获取网关路由器的 MAC 地址，需要使用 ARP 协议。

- 主机生成一个包含目的地址为网关路由器 IP 地址的 ARP 查询报文，将该 ARP 查询报文放入一个具有广播目的地址（FF:FF:FF:FF:FF:FF）的以太网帧中，并向交换机发送该以太网帧，交换机将该帧转发给所有的连接设备，包括网关路由器。

- 网关路由器接收到该帧后，不断向上分解得到 ARP 报文，发现其中的 IP 地址与其接口的 IP 地址匹配，因此就发送一个 ARP 回答报文，包含了它的 MAC 地址，发回给主机。

### 3. DNS 解析域名

- 知道了网关路由器的 MAC 地址之后，就可以继续 DNS 的解析过程了。

- 网关路由器接收到包含 DNS 查询报文的以太网帧后，抽取出 IP 数据报，并根据转发表决定该 IP 数据报应该转发的路由器。

- 因为路由器具有内部网关协议（RIP、OSPF）和外部网关协议（BGP）这两种路由选择协议，因此路由表中已经配置了网关路由器到达 DNS 服务器的路由表项。

- 到达 DNS 服务器之后，DNS 服务器抽取出 DNS 查询报文，并在 DNS 数据库中查找待解析的域名。

- 找到 DNS 记录之后，发送 DNS 回答报文，将该回答报文放入 UDP 报文段中，然后放入 IP 数据报中，通过路由器反向转发回网关路由器，并经过以太网交换机到达主机。

### 4. HTTP 请求页面

- 有了 HTTP 服务器的 IP 地址之后，主机就能够生成 TCP 套接字，该套接字将用于向 Web 服务器发送 HTTP GET 报文。

- 在生成 TCP 套接字之前，必须先与 HTTP 服务器进行三次握手来建立连接。生成一个具有目的端口 80 的 TCP SYN 报文段，并向 HTTP 服务器发送该报文段。

- HTTP 服务器收到该报文段之后，生成 TCP SYN ACK 报文段，发回给主机。

- 连接建立之后，浏览器生成 HTTP GET 报文，并交付给 HTTP 服务器。

- HTTP 服务器从 TCP 套接字读取 HTTP GET 报文，生成一个 HTTP 响应报文，将 Web 页面内容放入报文主体中，发回给主机。

- 浏览器收到 HTTP 响应报文后，抽取出 Web 页面内容，之后进行渲染，显示 Web 页面。



# 运输层协议

![img](/Image/A1.计算机网络-photo/339b3b923ab83b1e_img4-1623741071018)

#### IP不可靠

- 不确保报文段的交付
- 不保证报文段的按序交付
- 不保证报文段的数据完整性

UDP

- 不确定对方是否收到,即使出错对端也不会告知
- 无连接:不维护对端的信息

传输的最低限度:交付与差错检验

IP:维护网络与网络之间->TCP/UDP:进程与进程之间

每台主机只有一个IP地址

![img](/Image/A1.计算机网络-photo/339b3b923ab83b1e_img5-1623741071018)

层上分解,层下复用

多路分解:运输层报文段中的数据交付到正确的套接字的工作

多路复用:从源主机从不同套接字中手机数据块,为每个数据块添加首部信息,从而生成报文段

![img](/Image/A1.计算机网络-photo/339b3b923ab83b1e_img7-1623741071018)

端口与端口的连接维护是一个由

TCP套接字(源端口,目的端口,源IP,目的IP)组成的四元组

UDP套接字(目的IP和目的端口号)组成的二元组

#### UDP无连接原因

- 对何时,发送什么数据的应用层控制更精细
- 无需建立连接
- 无状态连接(不维护对端信息)
- 分组开销小(首部字段小)

网络风暴时,SNMP由UDP实现,以极有可能的方式发送

每一个数据包都有一个生命期限(多少跳),每经过一个路由器减一;

#### UDP 首部格式

![img](/Image/A1.计算机网络-photo/d4c3a4a1-0846-46ec-9cc3-eaddfca71254.jpg)

首部字段只有 8 个字节，包括源端口、目的端口、长度、检验和。12 字节的伪首部是为了计算检验和临时添加的

![img](/Image/A1.计算机网络-photo/339b3b923ab83b1e_img11-1623741071018)

rdt可靠数据传输

udt不可数据传输

## TCP协议

![img](/Image/A1.计算机网络-photo/339b3b923ab83b1e_img21-1623741071019)

#### TCP报文

![img](/Image/A1.计算机网络-photo/339b3b923ab83b1e_img22-1623741071019)

-   **序号**   ：用于对字节流进行编号，例如序号为 301，表示第一个字节的编号为 301，如果携带的数据长度为 100 字节，那么下一个报文段的序号应为 401。

-   **确认号**   ：期望收到的下一个报文段的序号。例如 B 正确收到 A 发送来的一个报文段，序号为 501，携带的数据长度为 200 字节，因此 B 期望下一个报文段的序号为 701，B 发送给 A 的确认报文段中确认号就为 701。

-   **数据偏移**   ：指的是数据部分距离报文段起始处的偏移量，实际上指的是首部的长度。

-   **确认 ACK**   ：当 ACK=1 时确认号字段有效，否则无效。TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 置 1。

-   **同步 SYN**   ：在连接建立时用来同步序号。当 SYN=1，ACK=0 时表示这是一个连接请求报文段。若对方同意建立连接，则响应报文中 SYN=1，ACK=1。

-   **终止 FIN**   ：用来释放一个连接，当 FIN=1 时，表示此报文段的发送方的数据已发送完毕，并要求释放连接。

-   **窗口**   ：窗口值作为接收方让发送方设置其发送窗口的依据。之所以要有这个限制，是因为接收方的数据缓存空间是有限的。

* **URG**：紧急比特（urgent），当 `URG＝1` 时，表明紧急指针字段有效，代表该封包为紧急封包。它告诉系统此报文段中有紧急数据，应尽快传送(相当于高优先级的数据)， 且上图中的 Urgent Pointer 字段也会被启用。
* **PSH**：（Push function）若为 1 时，代表要求对方立即传送缓冲区内的其他对应封包，而无需等缓冲满了才送。
* **RST**：复位比特(Reset)，当 `RST＝1` 时，表明 TCP 连接中出现严重差错（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立运输连接。



### TCP 的三次握手

![img](/Image/A1.计算机网络-photo/e92d0ebc-7d46-413b-aec1-34a39602f787.png)
假设 A 为客户端，B 为服务器端。

- 首先 B 处于 LISTEN（监听）状态，等待客户的连接请求。

- A 向 B 发送连接请求报文，SYN=1，ACK=0，选择一个初始的序号 x。

- B 收到连接请求报文，如果同意建立连接，则向 A 发送连接确认报文，SYN=1，ACK=1，确认号为 x+1，同时也选择一个初始的序号 y。

- A 收到 B 的连接确认报文后，还要向 B 发出确认，确认号为 y+1，序号为 x+1。

- B 收到 A 的确认后，连接建立。

#### **三次握手的原因**  

【答案一】因为信道不可靠，而 TCP 想在不可靠信道上建立可靠地传输，那么三次通信是理论上的最小值。（而 UDP 则不需建立可靠传输，因此 UDP 不需要三次握手。）

> [Google Groups . TCP 建立连接为什么是三次握手？{技术}{网络通信}](https://groups.google.com/forum/#!msg/pongba/kF6O7-MFxM0/5S7zIJ4yqKUJ)

【答案二】因为双方都需要确认对方收到了自己发送的序列号，确认过程最少要进行三次通信。

> [知乎 . TCP 为什么是三次握手，而不是两次或四次？](https://www.zhihu.com/question/24853633/answer/115173386)

【答案三】为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误。

第三次握手是为了防止失效的连接请求到达服务器，让服务器错误打开连接。

客户端发送的连接请求如果在网络中滞留，那么就会隔很长一段时间才能收到服务器端发回的连接确认。客户端等待一个超时重传时间之后，就会重新请求连接。但是这个滞留的连接请求最后还是会到达服务器，如果不进行三次握手，那么服务器就会打开两个连接。如果有第三次握手，客户端会忽略服务器之后发送的对滞留连接请求的连接确认，不进行第三次握手，因此就不会再次打开连接。



#### 流量控制

![img](/Image/A1.计算机网络-photo/339b3b923ab83b1e_img32-1623741071019)

接收方发送的确认报文中的窗口字段可以用来控制发送方窗口大小，从而影响发送方的发送速率。将窗口字段设置为 0，则发送方不能发送数据

#### 利用可变窗口进行流量控制

![](/Image/A1.计算机网络-photo/利用可变窗口进行流量控制举例-1623741071019.png)

rwnd接收窗口

cwnd拥塞窗口

### TCP 拥塞控制

如果网络出现拥塞，分组将会丢失，此时发送方会继续重传，从而导致网络拥塞程度更高。因此当出现拥塞时，应当控制发送方的速率。这一点和流量控制很像，但是出发点不同。流量控制是为了让接收方能来得及接收，而拥塞控制是为了降低整个网络的拥塞程度。

- 一个丢失的报文段意味着拥塞,丢包就应该减少发送端的发送速率

- 一个确认的报文段表示网络正在向接收方交付报文段,一次,当收到对之前报文的ACK后,应该增加发送方速率

- 带宽探测

  ![img](/Image/A1.计算机网络-photo/TCP的拥塞控制流程图-1623741071019.png)

  

### TCP 四次挥手释放连接

![UDP 报文](/Image/A1.计算机网络-photo/TCP四次挥手释放连接-1623741071019.png)

【TCP 释放连接全过程解释】

1. 客户端发送 FIN 给服务器，说明客户端不必发送数据给服务器了（请求释放从客户端到服务器的连接）；
2. 服务器接收到客户端发的 FIN，并回复 ACK 给客户端（同意释放从客户端到服务器的连接）；
3. 客户端收到服务端回复的 ACK，此时从客户端到服务器的连接已释放（但服务端到客户端的连接还未释放，并且客户端还可以接收数据）；
4. 服务端继续发送之前没发完的数据给客户端；
5. 服务端发送 FIN+ACK 给客户端，说明服务端发送完了数据（请求释放从服务端到客户端的连接，就算没收到客户端的回复，过段时间也会自动释放）；
6. 客户端收到服务端的 FIN+ACK，并回复 ACK 给客户端（同意释放从服务端到客户端的连接）；
7. 服务端收到客户端的 ACK 后，释放从服务端到客户端的连接。

##### TCP 为什么要进行四次挥手？

【问题一】TCP 为什么要进行四次挥手？ / 为什么 TCP 建立连接需要三次，而释放连接则需要四次？

【答案一】因为 TCP 是全双工模式，客户端请求关闭连接后，客户端向服务端的连接关闭（一二次挥手），服务端继续传输之前没传完的数据给客户端（数据传输），服务端向客户端的连接关闭（三四次挥手）。所以 TCP 释放连接时服务器的 ACK 和 FIN 是分开发送的（中间隔着数据传输），而 TCP 建立连接时服务器的 ACK 和 SYN 是一起发送的（第二次握手），所以 TCP 建立连接需要三次，而释放连接则需要四次。

【问题二】为什么 TCP 连接时可以 ACK 和 SYN 一起发送，而释放时则 ACK 和 FIN 分开发送呢？（ACK 和 FIN 分开是指第二次和第三次挥手）

【答案二】因为客户端请求释放时，服务器可能还有数据需要传输给客户端，因此服务端要先响应客户端 FIN 请求（服务端发送 ACK），然后数据传输，传输完成后，服务端再提出 FIN 请求（服务端发送 FIN）；而连接时则没有中间的数据传输，因此连接时可以 ACK 和 SYN 一起发送。

【问题三】为什么客户端释放最后需要 TIME-WAIT 等待 2MSL 呢？

【答案三】

1. 为了保证客户端发送的最后一个 ACK 报文能够到达服务端。若未成功到达，则服务端超时重传 FIN+ACK 报文段，客户端再重传 ACK，并重新计时。
2. 防止已失效的连接请求报文段出现在本连接中。TIME-WAIT 持续 2MSL 可使本连接持续的时间内所产生的所有报文段都从网络中消失，这样可使下次连接中不会出现旧的连接报文段。



![img](/Image/A1.计算机网络-photo/339b3b923ab83b1e_img28-1623741071019)

 

![img](/Image/A1.计算机网络-photo/339b3b923ab83b1e_img29-1623741071019)



### TCP 黏包问题

##### 原因

TCP 是一个基于字节流的传输服务（UDP 基于报文的），“流” 意味着 TCP 所传输的数据是没有边界的。所以可能会出现两个数据包黏在一起的情况。

##### 解决

* 发送定长包。如果每个消息的大小都是一样的，那么在接收对等方只要累计接收数据，直到数据等于一个定长的数值就将它作为一个消息。
* 包头加上包体长度。包头是定长的 4 个字节，说明了包体的长度。接收对等方先接收包头长度，依据包头长度来接收包体。
* 在数据包之间设置边界，如添加特殊符号 `\r\n` 标记。FTP 协议正是这么做的。但问题在于如果数据正文中也含有 `\r\n`，则会误判为消息的边界。
* 使用更加复杂的应用层协议。



### IP协议

![img](/Image/A1.计算机网络-photo/fb2604a4106781a9_img5-1623741071019)



每个主机都有一个 ARP 高速缓存，里面有本局域网上的各主机和路由器的 IP 地址到 MAC 地址的映射表。

如果主机 A 知道主机 B 的 IP 地址，但是 ARP 高速缓存中没有该 IP 地址到 MAC 地址的映射，此时主机 A 通过广播的方式发送 ARP 请求分组，主机 B 收到该请求后会发送 ARP 响应分组给主机 A 告知其 MAC 地址，随后主机 A 向其高速缓存中写入主机 B 的 IP 地址到 MAC 地址的映射。


![img](/Image/A1.计算机网络-photo/8006a450-6c2f-498c-a928-c927f758b1d0.png)

![img](/Image/A1.计算机网络-photo/fb2604a4106781a9_img6-1623741071019)

#### IP 网际协议

IP 地址分类：

* `IP 地址 ::= {<网络号>,<主机号>}`

| IP 地址类别 | 网络号                                 | 网络范围               | 主机号 | IP 地址范围                  |
| ----------- | -------------------------------------- | ---------------------- | ------ | ---------------------------- |
| A 类        | 8bit，第一位固定为 0                   | 0 —— 127               | 24bit  | 1.0.0.0 —— 127.255.255.255   |
| B 类        | 16bit，前两位固定为  10                | 128.0 —— 191.255       | 16bit  | 128.0.0.0 —— 191.255.255.255 |
| C  类       | 24bit，前三位固定为  110               | 192.0.0 —— 223.255.255 | 8bit   | 192.0.0.0 —— 223.255.255.255 |
| D  类       | 前四位固定为 1110，后面为多播地址      |                        |        |                              |
| E  类       | 前五位固定为 11110，后面保留为今后所用 |                        |        |                              |



![img](/Image/A1.计算机网络-photo/fb2604a4106781a9_img7-1623741071019)



### 网络层

* IP（Internet Protocol，网际协议）是为计算机网络相互连接进行通信而设计的协议。
* ARP（Address Resolution Protocol，地址解析协议）
* ICMP（Internet Control Message Protocol，网际控制报文协议）
* IGMP（Internet Group Management Protocol，网际组管理协议）



# 网络层



![img](/Image/A1.计算机网络-photo/a2c2efa0b214fcd8_img6-1623741071019)

#### 路由器的结构

路由器从功能上可以划分为：路由选择和分组转发。

分组转发结构由三个部分组成：交换结构、一组输入端口和一组输出端口。

![img](/Image/A1.计算机网络-photo/c3369072-c740-43b0-b276-202bd1d3960d.jpg)

#### 路由器分组转发流程

- 从数据报的首部提取目的主机的 IP 地址 D，得到目的网络地址 N。
- 若 N 就是与此路由器直接相连的某个网络地址，则进行直接交付；
- 若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给表中所指明的下一跳路由器；
- 若路由表中有到达网络 N 的路由，则把数据报传送给路由表中所指明的下一跳路由器；
- 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；
- 报告转发分组出错。

![img](/Image/A1.计算机网络-photo/a2c2efa0b214fcd8_img12-1623741071019)





# IP 数据报格式

![img](/Image/A1.计算机网络-photo/85c05fb1-5546-4c50-9221-21f231cdc8c5.jpg)

-   **版本**   : 有 4（IPv4）和 6（IPv6）两个值；

-   **首部长度**   : 占 4 位，因此最大值为 15。值为 1 表示的是 1 个 32 位字的长度，也就是 4 字节。因为固定部分长度为 20 字节，因此该值最小为 5。如果可选字段的长度不是 4 字节的整数倍，就用尾部的填充部分来填充。

-   **区分服务**   : 用来获得更好的服务，一般情况下不使用。

-   **总长度**   : 包括首部长度和数据部分长度。

-   **生存时间**   ：TTL，它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，当 TTL 为 0 时就丢弃数据报。

-   **上层协议**  ：指出携带的数据应该上交给哪个协议进行处理，例如 ICMP、TCP、UDP 等。

-   **首部检验和**  ：因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量。

-   **标识**   : 在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符。

-   **片偏移**   : 和标识符一起，用于发生分片的情况。片偏移的单位为 8 字节。

![img](/Image/A1.计算机网络-photo/23ba890e-e11c-45e2-a20c-64d217f83430.png)

### DHCP

动态主机配置协议 MAC地址->IP地址

![img](/Image/A1.计算机网络-photo/a2c2efa0b214fcd8_img17-1623741071019)



## NAT

![img](/Image/A1.计算机网络-photo/a2c2efa0b214fcd8_img18-1623741071019)





# 链路层协议

#### 链路层提供的服务

- 成帧
- 链路接入
- 可靠交付
- 差错检测和纠正

![img](/Image/A1.计算机网络-photo/437dc2ff98edb42a_img4-1623741071019)



#### 检测差错

- 奇偶校验
- 校验和
- 循环冗余校验



![img](/Image/A1.计算机网络-photo/437dc2ff98edb42a_img9-1623741071019)



信道划分协议 CDMA

![img](/Image/A1.计算机网络-photo/437dc2ff98edb42a_img16-1623741071019)



![img](/Image/A1.计算机网络-photo/437dc2ff98edb42a_img20-1623741071019)





![image-20210614183318984](/Image/A1.计算机网络-photo/image-20210614183318984-1623741071019.png)

